{
 "cells": [
  {
   "cell_type": "markdown",
   "id": "2468d14d",
   "metadata": {},
   "source": [
    "# Baseline corrections\n",
    "\n",
    "This tutorial shows how to make baseline corrections with spectrochempy.\n",
    "As prerequisite,\n",
    "the user is expected to have read the [Import](../importexport/import.ipynb)\n",
    "and [Import IR](../importexport/importIR.ipynb) tutorials."
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "e160e0c2",
   "metadata": {},
   "outputs": [],
   "source": [
    "import spectrochempy as scp"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "7c839e90",
   "metadata": {},
   "source": [
    "Now let's import and plot a typical IR dataset which was recorded during the\n",
    "removal of ammonia from a NH4-Y\n",
    "zeolite:"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "f40d1703",
   "metadata": {},
   "outputs": [],
   "source": [
    "X = scp.read_omnic(\"irdata/nh4y-activation.spg\")\n",
    "X[:, 1290.0:890.0] = scp.MASKED"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "087415ca",
   "metadata": {},
   "source": [
    "After setting some plotting preferences and plot it"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "76e08bd9",
   "metadata": {},
   "outputs": [],
   "source": [
    "prefs = X.preferences\n",
    "prefs.figure.figsize = (7, 3)\n",
    "prefs.colormap = \"magma\"\n",
    "_ = X.plot()"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "d93e7663",
   "metadata": {},
   "source": [
    "## Background subtraction\n",
    "\n",
    "Often, particularly for surface species, the baseline is first corrected\n",
    "by subtracting a reference spectrum. In this\n",
    "example, it could be, for instance, the last spectrum (index -1). Hence:"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "766cfe09",
   "metadata": {},
   "outputs": [],
   "source": [
    "Xdiff = X - X[-1]\n",
    "_ = Xdiff.plot()"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "e94a1ae9",
   "metadata": {},
   "source": [
    "## Detrend\n",
    "\n",
    "Other simple baseline corrections - often use in preprocessing prior chemometric\n",
    "analysis - constist in shifting\n",
    "the spectra or removing a linear trend. This is done using the detrend() method,\n",
    "which is a wrapper of the [\n",
    "detrend() method]\n",
    "(https://docs.scipy.org/doc/scipy/reference/generated/scipy.signal.detrend.html)\n",
    "from the [\n",
    "scipy.signal](https://docs.scipy.org/doc/scipy/reference/signal.html)\n",
    "module to which we refer the interested reader."
   ]
  },
  {
   "cell_type": "markdown",
   "id": "fcdb6388",
   "metadata": {},
   "source": [
    "### Linear trend\n",
    "Subtract the linear trend of each spectrum (type='linear', default)"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "96e4682e",
   "metadata": {},
   "outputs": [],
   "source": [
    "_ = X.detrend().plot()"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "18b74e0c",
   "metadata": {},
   "source": [
    "### Constant trend\n",
    "Subtract the average absorbance to each spectrum"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "bbf700d0",
   "metadata": {},
   "outputs": [],
   "source": [
    "_ = X.detrend(type=\"constant\").plot()"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "63b5e8b6",
   "metadata": {},
   "source": [
    "## Automatic linear baseline correction `abc`"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "6a9c7aa4",
   "metadata": {},
   "source": [
    "When the baseline to remove is a simple linear correction, one can use ``abc``.\n",
    "This performs an automatic baseline correction."
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "4db18b3f",
   "metadata": {},
   "outputs": [],
   "source": [
    "_ = scp.abc(X).plot()"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "8bbc3c24",
   "metadata": {},
   "source": [
    "## Advanced baseline correction\n",
    "\n",
    "'Advanced' baseline correction basically consists for the user to choose:\n",
    "\n",
    "- spectral ranges which s/he considers as belonging to the baseline - the type of\n",
    "polynomial(s) used to model the\n",
    "baseline in and between these regions (keyword: `interpolation`) - the method used\n",
    "to apply the correction to\n",
    "spectra: sequentially to each spectrum, or using a multivariate approach\n",
    "(keyword: `method`).\n",
    "\n",
    "### Range selection\n",
    "\n",
    "Each spectral range is defined by a list of two values indicating the limits of the\n",
    "spectral ranges, e.g. `[4500.,\n",
    "3500.]` to\n",
    "select the 4500-3500 cm$^{-1}$ range. Note that the ordering has no importance and\n",
    "using `[3500.0, 4500.]` would\n",
    "lead to exactly the same result. It is also possible to formally pick a single\n",
    "wavenumber `3750.`.\n",
    "\n",
    "The first step is then to select the various regions that we expect to belong to\n",
    "the baseline"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "272d7ea1",
   "metadata": {},
   "outputs": [],
   "source": [
    "ranges = [5900.0, 5400.0], 4550.0, [4500.0, 4000.0], [2100.0, 2000.0], [1550.0, 1555.0]"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "74797041",
   "metadata": {},
   "source": [
    "After selection of the baseline ranges, the baseline correction can be made using a\n",
    "sequence of 2 commands:\n",
    "\n",
    "1. Initialize an instance of BaselineCorrection"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "efc2ce1a",
   "metadata": {},
   "outputs": [],
   "source": [
    "blc = scp.BaselineCorrection(X)"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "6b430f38",
   "metadata": {},
   "source": [
    "2. compute baseline other the ranges"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "fdb9ccbe",
   "metadata": {},
   "outputs": [],
   "source": [
    "Xcorr = blc.compute(ranges)\n",
    "Xcorr"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "9ddb9e56",
   "metadata": {},
   "source": [
    "* plot the result (blc.corrected.plot() would lead to the same result)"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "5bd1f6a6",
   "metadata": {},
   "outputs": [],
   "source": [
    "_ = Xcorr.plot()"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "1f465ca4",
   "metadata": {},
   "source": [
    "### Interpolation method\n",
    "\n",
    "\n",
    "The previous correction was made using the default parameters for the interpolation\n",
    ",i.e. an interpolation using cubic Hermite spline interpolation:\n",
    "`interpolation='pchip'` (`pchip` stands for\n",
    "**P**iecewise **C**ubic **H**ermite\n",
    "**I**nterpolating **P**olynomial). This option triggers the use of\n",
    "[scipy.interpolate.PchipInterpolator()](\n",
    "https://docs.scipy.org/doc/scipy/reference/generated/scipy.interpolate.PchipInterpolator.html)\n",
    "to which we refer the interested readers. The other interpolation method is the\n",
    "classical polynomial interpolation (`interpolation='polynomial'`) in which case the\n",
    "order can also be set (e.g. `order=3`, the default value being 6).\n",
    "In this case, the base methods used for the interpolation are those of the\n",
    "[polynomial module](\n",
    "https://numpy.org/doc/stable/reference/routines.polynomials.polynomial.html)\n",
    "of spectrochempy, in particular the\n",
    "[polyfit()](\n",
    "https://numpy.org/doc/stable/reference/generated/numpy.polynomial.polynomial.polyfit.html#numpy.polynomial.polynomial.polyfit) method.\n",
    "\n",
    "For instance:"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "4fca50a8",
   "metadata": {},
   "source": [
    "First, we put the ranges in a list"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "9cfda397",
   "metadata": {},
   "outputs": [],
   "source": [
    "ranges = [[5900.0, 5400.0], [4000.0, 4500.0], [2100.0, 2000.0], [1550.0, 1555.0]]"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "722238e7",
   "metadata": {},
   "source": [
    "<div class='alert alert-warning'>\n",
    "<b>Warning</b>\n",
    "\n",
    "if you use a tuple to define the sequences of ranges:\n",
    "\n",
    "```ipython3\n",
    "ranges = [5900.0, 5400.0], [4000., 4500.], [2100., 2000.0], [1550., 1555.]\n",
    "```\n",
    "\n",
    "or\n",
    "\n",
    "```ipython3\n",
    "ranges = ([5900.0, 5400.0], [4000., 4500.], [2100., 2000.0], [1550., 1555.])\n",
    "```\n",
    "\n",
    "then you can call `compute` by directly pass the ranges tuple, or you can unpack\n",
    "it as below.\n",
    "\n",
    "```ipython3\n",
    "blc.compute(ranges, ....)\n",
    "```\n",
    "\n",
    "\n",
    "if you use a list instead of tuples:\n",
    "\n",
    "```ipython3\n",
    "ranges = [[5900.0, 5400.0], [4000., 4500.], [2100., 2000.0], [1550., 1555.]]\n",
    "```\n",
    "\n",
    "then you **MUST UNPACK** the element when calling `compute`:\n",
    "\n",
    "```ipython3\n",
    "blc.compute(*ranges, ....)\n",
    "```\n",
    "\n",
    "\n",
    "</div>"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "97a2268c",
   "metadata": {},
   "outputs": [],
   "source": [
    "blc = scp.BaselineCorrection(X)\n",
    "blc.compute(*ranges, interpolation=\"polynomial\", order=6)"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "c45cd918",
   "metadata": {},
   "source": [
    "The `corrected` attribute contains the corrected NDDataset."
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "ce95021f",
   "metadata": {},
   "outputs": [],
   "source": [
    "_ = blc.corrected.plot()"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "c6dcc1da",
   "metadata": {},
   "source": [
    "### Multivariate method\n",
    "\n",
    "The `method` option defines whether the selected baseline regions of the spectra\n",
    "should be taken 'as is'\n",
    "this is the default `method='sequential'`), or modeled using a multivariate\n",
    "approach (`method='multivariate'`).\n",
    "\n",
    "The `'multivariate'` option is useful when the signal‐to‐noise ratio is low\n",
    "and/or when the baseline changes in\n",
    "various regions of the spectrum are correlated. It consist in (i) modeling the\n",
    "baseline regions by a principal\n",
    "component analysis (PCA), (ii) interpolate the loadings of the first principal\n",
    "components over the whole spectral\n",
    "and (iii) modeling the spectra baselines from the product of the PCA scores and\n",
    "the interpolated loadings.\n",
    "(for detail: see [Vilmin et al. Analytica Chimica Acta 891\n",
    "(2015)](http://dx.doi.org/10.1016/j.aca.2015.06.006)).\n",
    "\n",
    "If this option is selected, the user should also choose `npc`, the number of\n",
    "principal components used to model the\n",
    "baseline. In a sense, this parameter has the same role as the `order` parameter,\n",
    "except that it will affect how well\n",
    "the baseline fits the selected regions, but on *both dimensions: wavelength\n",
    "and acquisition time*. In particular a\n",
    "large value of `npc` will lead to overfit of baseline variation with time and will\n",
    "lead to the same result as the\n",
    "`sequential` method while a too small `value` would miss important principal\n",
    "component underlying the baseline change\n",
    "over time. Typical optimum values are `npc=2` or `npc=3` (see Exercises below)."
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "00e1fc70",
   "metadata": {},
   "outputs": [],
   "source": [
    "blc = scp.BaselineCorrection(X)\n",
    "blc.compute(*ranges, interpolation=\"pchip\", method=\"multivariate\", npc=2)\n",
    "_ = blc.corrected.plot()"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "e3cb4337",
   "metadata": {},
   "source": [
    "### Code snippet for 'advanced' baseline correction\n",
    "The following code in which the user can change any of the parameters and look at\n",
    "the changes after re-running\n",
    "the cell:"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "55152844",
   "metadata": {},
   "outputs": [],
   "source": [
    "# user defined parameters\n",
    "# -----------------------\n",
    "ranges = (\n",
    "    [5900.0, 5400.0],\n",
    "    [4000.0, 4500.0],\n",
    "    4550.0,\n",
    "    [2100.0, 2000.0],\n",
    "    [1550.0, 1555.0],\n",
    "    [1250.0, 1300.0],\n",
    "    [800.0, 850.0],\n",
    ")\n",
    "interpolation = \"pchip\"  # choose 'polynomial' or 'pchip'\n",
    "order = 5  # only used for 'polynomial'\n",
    "method = \"sequential\"  # choose 'sequential' or 'multivariate'\n",
    "npc = 3  # only used for 'multivariate'\n",
    "\n",
    "# code: compute baseline, plot original and corrected NDDatasets and ranges\n",
    "# -------------------------------------------------------------------------\n",
    "blc = scp.BaselineCorrection(X)\n",
    "Xcorr = blc.compute(\n",
    "    *ranges, interpolation=interpolation, order=order, method=method, npc=npc\n",
    ")\n",
    "\n",
    "axes = scp.multiplot(\n",
    "    [X, Xcorr],\n",
    "    labels=[\"Original\", \"Baseline corrected\"],\n",
    "    sharex=True,\n",
    "    nrow=2,\n",
    "    ncol=1,\n",
    "    figsize=(7, 6),\n",
    "    dpi=96,\n",
    ")\n",
    "blc.show_regions(axes[\"axe21\"])"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "bfff8bbb",
   "metadata": {},
   "source": [
    "### Widget for \"advanced\" baseline corrections"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "3dd6a197",
   "metadata": {},
   "source": [
    "The ``BaselineCorrector`` widget can be used in either Jupyter notebook or Jupyter\n",
    "lab.\n",
    "\n",
    "The buttons are the following:\n",
    "* `upload`: allows to upload new data.\n",
    "* `process` : baseline correct and plot original dataset + baseline and corrected\n",
    "datasets\n",
    "* `save as`: save the baseline corrected dataset.\n",
    "\n",
    "The `x slice` and `y slice` text boxes can be used to slice the original dataset\n",
    "with the usual `[start:stop:step]` format. In both dimensions, coordinates or indexes\n",
    "can be used (for example, [3000.0::2] or [:100:5] are valid entries).\n",
    "\n",
    "The `Method` and `Interpolation` dropdown fields are self-explanatory,\n",
    "see above for details.\n",
    "\n",
    "`Ranges` must be entered as a tuple of digits or wave numbers,\n",
    "e.g. `([5900.0, 5400.0], 2000.0, [1550.0, 1555.0],)`."
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "1d59d9b3",
   "metadata": {},
   "outputs": [],
   "source": [
    "X = scp.read_omnic(\"irdata/nh4y-activation.spg\")\n",
    "out = scp.BaselineCorrector(X)"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "40d1439c",
   "metadata": {},
   "source": [
    "After processing, one can get the original (sliced) dataset, corrected dataset\n",
    "and baselines\n",
    "through the following attributes:"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "0f9da247",
   "metadata": {},
   "outputs": [],
   "source": [
    "out.original, out.corrected, out.baseline"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "88511de3",
   "metadata": {},
   "source": [
    "<div class='alert alert-info'>\n",
    "    <b>Exercises</b>\n",
    "\n",
    "**basic:**\n",
    "- write commands to subtract (i) the first spectrum from a dataset and (ii)\n",
    "the mean spectrum from a dataset\n",
    "- write a code to correct the baseline of the last 10 spectra of the above dataset\n",
    "in the 4000-3500 cm$^{-1}$ range\n",
    "\n",
    "**intermediate:**\n",
    "- what would be the parameters to use in 'advanced' baseline correction to mimic\n",
    "'detrend' ? Write a code to check\n",
    "your answer.\n",
    "\n",
    "**advanced:**\n",
    "- simulate noisy spectra with baseline drifts and compare the performances of\n",
    "`multivariate` vs `sequential` methods\n",
    "</div>"
   ]
  }
 ],
 "metadata": {
  "jupytext": {
   "encoding": "# -*- coding: utf-8 -*-",
   "formats": "ipynb,py:percent",
   "notebook_metadata_filter": "all"
  },
  "kernelspec": {
   "display_name": "Python 3 (ipykernel)",
   "language": "python",
   "name": "python3"
  },
  "language_info": {
   "codemirror_mode": {
    "name": "ipython",
    "version": 3
   },
   "file_extension": ".py",
   "mimetype": "text/x-python",
   "name": "python",
   "nbconvert_exporter": "python",
   "pygments_lexer": "ipython3",
   "version": "3.9.10"
  }
 },
 "nbformat": 4,
 "nbformat_minor": 5
}
